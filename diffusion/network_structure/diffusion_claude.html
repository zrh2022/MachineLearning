<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDPMå®Œæ•´ç½‘ç»œæ¶æ„å›¾</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #333;
            overflow-x: auto;
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            min-width: 1600px;
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .main-diagram {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 20px;
            margin: 20px 0;
            min-height: 1200px;
        }

        .process-section {
            border: 3px solid;
            border-radius: 15px;
            padding: 20px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .forward-process {
            grid-column: 1;
            grid-row: 1;
            border-color: #e74c3c;
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
        }

        .reverse-process {
            grid-column: 1;
            grid-row: 2;
            border-color: #27ae60;
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        }

        .unet-detail {
            grid-column: 2;
            grid-row: 1 / 4;
            border-color: #3498db;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            max-height: 1200px;
            overflow-y: auto;
        }

        .training-detail {
            grid-column: 1;
            grid-row: 3;
            border-color: #9b59b6;
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
        }

        .tensor-box {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 3px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .tensor-box:hover {
            transform: scale(1.05);
        }

        .operation-box {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 3px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .operation-box:hover {
            transform: scale(1.05);
        }

        .layer-box {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .layer-box:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .attention-box {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 6px 0;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .attention-box:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .time-embed-box {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            color: #333;
            padding: 10px;
            border-radius: 8px;
            margin: 6px 0;
            font-size: 10px;
            font-weight: bold;
            border: 2px solid #f39c12;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .time-embed-box:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 12px rgba(243, 156, 18, 0.3);
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            border-bottom: 2px solid rgba(44, 62, 80, 0.2);
            padding-bottom: 8px;
        }

        .math-formula {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            border-left: 4px solid #3498db;
            margin: 8px 0;
            font-size: 11px;
            line-height: 1.4;
        }

        .flow-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            margin: 10px 0;
            gap: 5px;
        }

        .arrow-symbol {
            font-size: 20px;
            color: #34495e;
            font-weight: bold;
            margin: 0 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .legend {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #bdc3c7;
            font-size: 12px;
            margin-top: 20px;
        }

        .tooltip {
            position: relative;
            cursor: pointer;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            background: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 1000;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .tooltip:hover::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #2c3e50;
            z-index: 1001;
        }

        .interactive-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .interactive-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .interactive-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .interactive-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: width 0.3s ease, height 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .interactive-btn:active::before {
            width: 100px;
            height: 100px;
        }

        .btn-forward { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-reverse { background: linear-gradient(135deg, #27ae60, #229954); }
        .btn-unet { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-reset { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }

        .highlighted {
            box-shadow: 0 0 30px rgba(52, 152, 219, 0.8) !important;
            transform: scale(1.02) !important;
            z-index: 10;
        }

        .dimmed {
            opacity: 0.3 !important;
            transform: scale(0.98) !important;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, #3498db, #2980b9);
            z-index: 5;
            animation: flow 2s ease-in-out infinite;
        }

        @keyframes flow {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }

        .unet-layers {
            max-height: 800px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .unet-layers::-webkit-scrollbar {
            width: 6px;
        }

        .unet-layers::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .unet-layers::-webkit-scrollbar-thumb {
            background: rgba(52, 152, 219, 0.6);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ DDPM (Denoising Diffusion Probabilistic Models) å®Œæ•´ç½‘ç»œæ¶æ„å›¾</h1>

        <div class="main-diagram">
            <!-- Forward Process -->
            <div class="process-section forward-process" id="forward-section">
                <div class="section-title">ğŸ“ˆ å‰å‘æ‰©æ•£è¿‡ç¨‹ (Forward Diffusion Process)</div>
                <div class="math-formula">q(xâ‚:T|xâ‚€) = âˆáµ—áµ¢â‚Œâ‚ q(xáµ¢|xáµ¢â‚‹â‚)</div>

                <div class="flow-container">
                    <span class="tensor-box tooltip" data-tooltip="åŸå§‹æ¸…æ™°å›¾åƒï¼ŒRGBæ ¼å¼">xâ‚€: [4,3,64,64]</span>
                    <span class="operation-box tooltip" data-tooltip="æ·»åŠ é«˜æ–¯å™ªå£°">+ âˆšÎ²â‚œÂ·Îµ</span>
                    <span class="tensor-box tooltip" data-tooltip="æ ‡å‡†é«˜æ–¯å™ªå£°">Îµ~ğ’©(0,I): [4,3,64,64]</span>
                </div>

                <div class="flow-container">
                    <span class="tensor-box">xâ‚: [4,3,64,64]</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="tensor-box">xâ‚‚: [4,3,64,64]</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="tensor-box">...</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="tensor-box tooltip" data-tooltip="æ—¶é—´æ­¥tçš„å™ªå£°å›¾åƒ">xâ‚œ: [4,3,64,64]</span>
                </div>

                <div class="math-formula">
                    <strong>é‡å‚æ•°åŒ–æŠ€å·§:</strong><br>
                    xâ‚œ = âˆšÎ±Ì…â‚œÂ·xâ‚€ + âˆš(1-Î±Ì…â‚œ)Â·Îµ<br>
                    å…¶ä¸­: Î±Ì…â‚œ = âˆáµ¢â‚Œâ‚áµ— Î±áµ¢, Î±â‚œ = 1-Î²â‚œ<br>
                    å™ªå£°è°ƒåº¦: Î²â‚=1e-4 â†’ Î²â‚œ=0.02 (çº¿æ€§)
                </div>

                <div style="margin-top: 15px;">
                    <strong>å¼ é‡æ“ä½œè¯¦è§£:</strong>
                    <div class="grid-container">
                        <div class="tensor-box tooltip" data-tooltip="æ‰¹é‡å¤§å°4">B = 4</div>
                        <div class="tensor-box tooltip" data-tooltip="RGBä¸‰é€šé“">C = 3</div>
                        <div class="tensor-box tooltip" data-tooltip="å›¾åƒé«˜åº¦">H = 64</div>
                        <div class="tensor-box tooltip" data-tooltip="å›¾åƒå®½åº¦">W = 64</div>
                    </div>
                </div>
            </div>

            <!-- Reverse Process -->
            <div class="process-section reverse-process" id="reverse-section">
                <div class="section-title">ğŸ“‰ åå‘å»å™ªè¿‡ç¨‹ (Reverse Denoising Process)</div>
                <div class="math-formula">pÎ¸(xâ‚€:T) = p(xâ‚œ)âˆáµ—áµ¢â‚Œâ‚ pÎ¸(xáµ¢â‚‹â‚|xáµ¢)</div>

                <div class="flow-container">
                    <span class="tensor-box tooltip" data-tooltip="å«å™ªå£°çš„è¾“å…¥">xâ‚œ: [4,3,64,64]</span>
                    <span class="arrow-symbol">+</span>
                    <span class="tensor-box tooltip" data-tooltip="æ—¶é—´æ­¥ä¿¡æ¯">t: [4,]</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="operation-box tooltip" data-tooltip="U-Netå™ªå£°é¢„æµ‹ç½‘ç»œ">ÎµÎ¸(xâ‚œ,t)</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="tensor-box tooltip" data-tooltip="é¢„æµ‹çš„å™ªå£°">ÎµÌ‚: [4,3,64,64]</span>
                </div>

                <div class="flow-container">
                    <span class="tensor-box">t: [4,]</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="operation-box">Sinusoidal</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="tensor-box">t_sin: [4,128]</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="operation-box">MLP</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="tensor-box">t_emb: [4,512]</span>
                </div>

                <div class="math-formula">
                    <strong>æŸå¤±å‡½æ•° (ç®€åŒ–ç›®æ ‡):</strong><br>
                    L_simple = ğ”¼â‚œ,xâ‚€,Îµ [||Îµ - ÎµÎ¸(âˆšÎ±Ì…â‚œÂ·xâ‚€ + âˆš(1-Î±Ì…â‚œ)Â·Îµ, t)||Â²]<br><br>

                    <strong>å»å™ªé‡‡æ ·:</strong><br>
                    Î¼â‚œ = (xâ‚œ - Î²â‚œ/âˆš(1-Î±Ì…â‚œ)Â·ÎµÎ¸(xâ‚œ,t))/âˆšÎ±â‚œ<br>
                    xâ‚œâ‚‹â‚ = Î¼â‚œ + Ïƒâ‚œÂ·z, z~ğ’©(0,I)
                </div>
            </div>

            <!-- Training Detail -->
            <div class="process-section training-detail" id="training-section">
                <div class="section-title">ğŸ“ è®­ç»ƒè¿‡ç¨‹ (Training Procedure)</div>

                <div class="flow-container">
                    <span class="operation-box">Sample xâ‚€</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="operation-box">Sample t,Îµ</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="operation-box">Forward xâ‚œ</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="operation-box">Predict ÎµÌ‚</span>
                    <span class="arrow-symbol">â†’</span>
                    <span class="operation-box">Compute Loss</span>
                </div>

                <div class="math-formula">
                    <strong>è®­ç»ƒç®—æ³•:</strong><br>
                    1. xâ‚€ ~ q(xâ‚€) - ä»æ•°æ®é›†é‡‡æ ·<br>
                    2. t ~ Uniform(1,T) - éšæœºæ—¶é—´æ­¥<br>
                    3. Îµ ~ ğ’©(0,I) - é‡‡æ ·å™ªå£°<br>
                    4. xâ‚œ = âˆšÎ±Ì…â‚œÂ·xâ‚€ + âˆš(1-Î±Ì…â‚œ)Â·Îµ - å‰å‘æ‰©æ•£<br>
                    5. ÎµÌ‚ = ÎµÎ¸(xâ‚œ,t) - ç½‘ç»œé¢„æµ‹<br>
                    6. L = ||Îµ - ÎµÌ‚||Â² - è®¡ç®—æŸå¤±<br>
                    7. Î¸ â† Î¸ - Î·âˆ‡Î¸L - æ¢¯åº¦æ›´æ–°
                </div>

                <div class="grid-container">
                    <div class="tensor-box">å­¦ä¹ ç‡: Î·=2e-4</div>
                    <div class="tensor-box">æ—¶é—´æ­¥: T=1000</div>
                    <div class="tensor-box">æ‰¹é‡å¤§å°: B=4</div>
                    <div class="tensor-box">ä¼˜åŒ–å™¨: Adam</div>
                </div>
            </div>

            <!-- U-Net Detailed Architecture -->
            <div class="process-section unet-detail" id="unet-section">
                <div class="section-title">ğŸ—ï¸ U-Net ÎµÎ¸ è¯¦ç»†æ¶æ„</div>

                <div class="unet-layers">
                    <!-- Time Embedding -->
                    <div class="time-embed-box tooltip" data-tooltip="å°†æ—¶é—´æ­¥tç¼–ç ä¸ºé«˜ç»´å‘é‡">
                        <strong>ğŸ• æ—¶é—´åµŒå…¥å±‚ (Time Embedding)</strong><br>
                        è¾“å…¥: t [4,] (æ•´æ•°æ—¶é—´æ­¥)<br>
                        â†“<br>
                        Sinusoidalä½ç½®ç¼–ç : t â†’ [4,128]<br>
                        å…¬å¼: PE(t,2i) = sin(t/10000^(2i/128))<br>
                        â†“<br>
                        Linear1: [4,128] Ã— Wâ‚[128,512] + bâ‚[512] â†’ [4,512]<br>
                        â†“<br>
                        SiLUæ¿€æ´»: xÂ·sigmoid(x) â†’ [4,512]<br>
                        â†“<br>
                        Linear2: [4,512] Ã— Wâ‚‚[512,512] + bâ‚‚[512] â†’ [4,512]<br>
                        è¾“å‡º: t_emb [4,512]
                    </div>

                    <!-- Input Layer -->
                    <div class="layer-box tooltip" data-tooltip="è¾“å…¥å·ç§¯å±‚ï¼Œå¢åŠ é€šé“æ•°">
                        <strong>ğŸ“¥ è¾“å…¥å±‚ (Input Conv)</strong><br>
                        è¾“å…¥: xâ‚œ [4,3,64,64]<br>
                        Conv2d: [4,3,64,64] * W[128,3,3,3] + b[128]<br>
                        â†’ hâ‚€ [4,128,64,64] (padding=1, stride=1)
                    </div>

                    <!-- Encoder Path -->
                    <div style="border-left: 4px solid #e74c3c; padding-left: 15px; margin: 15px 0;">
                        <h4 style="color: #e74c3c; margin-bottom: 10px;">ğŸ”½ ç¼–ç å™¨è·¯å¾„ (Encoder)</h4>

                        <div class="layer-box tooltip" data-tooltip="ç¬¬ä¸€ä¸ªç¼–ç å—ï¼Œç»´æŒåˆ†è¾¨ç‡">
                            <strong>Encoder Block 1 (64Ã—64)</strong><br>
                            è¾“å…¥: hâ‚€ [4,128,64,64]<br>
                            ResNetBlock: {<br>
                            ã€€GroupNorm â†’ SiLU â†’ Conv3Ã—3 â†’ [4,128,64,64]<br>
                            ã€€+ t_embæŠ•å½±: [4,512] â†’ Linear â†’ [4,128] â†’ [4,128,1,1]<br>
                            ã€€GroupNorm â†’ SiLU â†’ Conv3Ã—3 â†’ [4,128,64,64]<br>
                            ã€€+ æ®‹å·®è¿æ¥<br>
                            }<br>
                            è¾“å‡º: hâ‚ [4,128,64,64] <strong style="color: #f39c12;">(ä¿å­˜skipâ‚)</strong>
                        </div>

                        <div class="attention-box tooltip" data-tooltip="ç©ºé—´è‡ªæ³¨æ„åŠ›ï¼Œå»ºç«‹é•¿ç¨‹ä¾èµ–">
                            <strong>ğŸ¯ Self-Attention (64Ã—64)</strong><br>
                            è¾“å…¥: hâ‚ [4,128,64,64]<br>
                            Reshape: [4,128,4096] â†’ Transpose: [4,4096,128]<br>
                            Q,K,V = Linear: [4,4096,128] â†’ 3Ã—[4,4096,128]<br>
                            MultiHead(heads=8): [4,4096,8,16]<br>
                            Attention: softmax(QK^T/âˆš16)V â†’ [4,4096,128]<br>
                            è¾“å‡º: [4,128,64,64]
                        </div>

                        <div class="layer-box tooltip" data-tooltip="ä¸‹é‡‡æ ·åˆ°32Ã—32ï¼Œå¢åŠ é€šé“æ•°">
                            <strong>Encoder Block 2 (32Ã—32)</strong><br>
                            è¾“å…¥: hâ‚ [4,128,64,64]<br>
                            ResNetBlock â†’ [4,256,64,64]<br>
                            + t_emb: [4,512] â†’ [4,256] â†’ [4,256,1,1]<br>
                            Downsample: AvgPool2d(2) â†’ hâ‚‚ [4,256,32,32]<br>
                            <strong style="color: #f39c12;">(ä¿å­˜skipâ‚‚)</strong>
                        </div>

                        <div class="layer-box tooltip" data-tooltip="ç»§ç»­ä¸‹é‡‡æ ·åˆ°16Ã—16">
                            <strong>Encoder Block 3 (16Ã—16)</strong><br>
                            è¾“å…¥: hâ‚‚ [4,256,32,32]<br>
                            ResNetBlock â†’ [4,512,32,32]<br>
                            + t_emb: [4,512] â†’ [4,512] â†’ [4,512,1,1]<br>
                            Downsample: AvgPool2d(2) â†’ hâ‚ƒ [4,512,16,16]<br>
                            <strong style="color: #f39c12;">(ä¿å­˜skipâ‚ƒ)</strong>
                        </div>

                        <div class="layer-box tooltip" data-tooltip="æœ€åä¸‹é‡‡æ ·åˆ°8Ã—8">
                            <strong>Encoder Block 4 (8Ã—8)</strong><br>
                            è¾“å…¥: hâ‚ƒ [4,512,16,16]<br>
                            ResNetBlock â†’ [4,512,16,16]<br>
                            + t_emb: [4,512] â†’ [4,512] â†’ [4,512,1,1]<br>
                            Downsample: AvgPool2d(2) â†’ hâ‚„ [4,512,8,8]<br>
                            <strong style="color: #f39c12;">(ä¿å­˜skipâ‚„)</strong>
                        </div>
                    </div>

                    <!-- Bottleneck -->
                    <div style="border-left: 4px solid #f39c12; padding-left: 15px; margin: 15px 0;">
                        <h4 style="color: #f39c12; margin-bottom: 10px;">âš¡ ç“¶é¢ˆå±‚ (Bottleneck)</h4>

                        <div class="layer-box tooltip" data-tooltip="æœ€æ·±å±‚ç‰¹å¾å¤„ç†" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                            <strong>Middle Processing (8Ã—8)</strong><br>
                            è¾“å…¥: hâ‚„ [4,512,8,8]<br>
                            â†“<br>
                            ResNetBlock1: {<br>
                            ã€€GroupNorm([4,512,8,8]) â†’ SiLU<br>
                            ã€€Conv3Ã—3: [4,512,8,8] * W[512,512,3,3] â†’ [4,512,8,8]<br>
                            ã€€+ t_embæ³¨å…¥: [4,512] â†’ [4,512,1,1]<br>
                            ã€€GroupNorm â†’ SiLU â†’ Conv3Ã—3<br>
                            ã€€+ æ®‹å·®è¿æ¥<br>
                            }<br>
                            â†“<br>
                            Self-Attention: [4,512,64] â†’ QKV â†’ [4,512,64]<br>
                            â†“<br>
                            ResNetBlock2: åŒä¸Šç»“æ„<br>
                            è¾“å‡º: m [4,512,8,8]
                        </div>
                    </div>

                    <!-- Decoder Path -->
                    <div style="border-left: 4px solid #27ae60; padding-left: 15px; margin: 15px 0;">
                        <h4 style="color: #27ae60; margin-bottom: 10px;">ğŸ”¼ è§£ç å™¨è·¯å¾„ (Decoder)</h4>

                        <div class="layer-box tooltip" data-tooltip="ä¸Šé‡‡æ ·åˆ°16Ã—16ï¼Œèåˆskipè¿æ¥">
                            <strong>Decoder Block 1 (16Ã—16)</strong><br>
                            è¾“å…¥: m [4,512,8,8]<br>
                            Upsample: Interpolate(scale=2) â†’ [4,512,16,16]<br>
                            Skipè¿æ¥: concat(up, skipâ‚„) â†’ [4,1024,16,16]<br>
                            Conv1Ã—1: [4,1024,16,16] * W[512,1024,1,1] â†’ [4,512,16,16]<br>
                            ResNetBlock + t_emb â†’ dâ‚ [4,512,16,16]
                        </div>

                        <div class="layer-box tooltip" data-tooltip="ä¸Šé‡‡æ ·åˆ°32Ã—32ï¼Œå‡å°‘é€šé“æ•°">
                            <strong>Decoder Block 2 (32Ã—32)</strong><br>
                            è¾“å…¥: dâ‚ [4,512,16,16]<br>
                            Upsample: Interpolate(scale=2) â†’ [4,512,32,32]<br>
                            Skipè¿æ¥: concat(up, skipâ‚ƒ) â†’ [4,1024,32,32]<br>
                            Conv1Ã—1: [4,1024,32,32] * W[256,1024,1,1] â†’ [4,256,32,32]<br>
                            ResNetBlock + t_emb â†’ dâ‚‚ [4,256,32,32]
                        </div>

                        <div class="layer-box tooltip" data-tooltip="ä¸Šé‡‡æ ·åˆ°64Ã—64ï¼Œè¿›ä¸€æ­¥å‡å°‘é€šé“">
                            <strong>Decoder Block 3 (64Ã—64)</strong><br>
                            è¾“å…¥: dâ‚‚ [4,256,32,32]<br>
                            Upsample: Interpolate(scale=2) â†’ [4,256,64,64]<br>
                            Skipè¿æ¥: concat(up, skipâ‚‚) â†’ [4,512,64,64]<br>
                            Conv1Ã—1: [4,512,64,64] * W[128,512,1,1] â†’ [4,128,64,64]<br>
                            ResNetBlock + t_emb â†’ dâ‚ƒ [4,128,64,64]
                        </div>

                        <div class="attention-box tooltip" data-tooltip="æœ€ç»ˆå±‚å‰çš„æ³¨æ„åŠ›æœºåˆ¶">
                            <strong>ğŸ¯ Final Self-Attention (64Ã—64)</strong><br>
                            è¾“å…¥: dâ‚ƒ [4,128,64,64]<br>
                            Same as encoder attention â†’ [4,128,64,64]
                        </div>

                        <div class="layer-box tooltip" data-tooltip="æœ€ç»ˆè¾“å‡ºå±‚ï¼Œé¢„æµ‹å™ªå£°">
                            <strong>Final Output Layer</strong><br>
                            è¾“å…¥: dâ‚ƒ [4,128,64,64]<br>
                            Skipè¿æ¥: concat(dâ‚ƒ, skipâ‚) â†’ [4,256,64,64]<br>
                            GroupNorm: groups=8 â†’ [4,256,64,64]<br>
                            SiLU: [4,256,64,64] â†’ [4,256,64,64]<br>
                            Conv2d: [4,256,64,64] * W[3,256,3,3] + b[3]<br>
                            â†’ <strong style="color: #e74c3c;">ÎµÌ‚ [4,3,64,64]</strong> (é¢„æµ‹å™ªå£°)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Tensor Operations -->
        <div style="margin-top: 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px;">
            <h2 style="margin-bottom: 20px;">ğŸ” å…³é”®å¼ é‡æ“ä½œè¯¦è§£</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                <div>
                    <h3>ğŸ§® ResNetå—å¼ é‡æµåŠ¨</h3>
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; font-family: monospace; font-size: 10px; line-height: 1.5;">
                        <strong>è¾“å…¥:</strong> x [B, C_in, H, W]<br>
                        <strong>æƒé‡:</strong> Wâ‚[C_out, C_in, 3, 3], bâ‚[C_out]<br>
                        <strong>æ—¶é—´åµŒå…¥:</strong> t_emb [B, 512]<br><br>

                        <strong>è®¡ç®—æ­¥éª¤:</strong><br>
                        1. norm1 = GroupNorm(x, groups=8)<br>
                        ã€€ Î¼ = mean(x, dim=[2,3]), Ïƒ = std(x, dim=[2,3])<br>
                        ã€€ norm1 = Î³(x-Î¼)/Ïƒ + Î² â†’ [B, C_in, H, W]<br><br>

                        2. act1 = SiLU(norm1) = norm1 * sigmoid(norm1)<br><br>

                        3. conv1 = Conv2d(act1, Wâ‚, bâ‚)<br>
                        ã€€ [B,C_in,H,W] âŠ› [C_out,C_in,3,3] â†’ [B,C_out,H,W]<br><br>

                        4. time_proj = Linear(t_emb): [B,512] â†’ [B,C_out]<br>
                        ã€€ reshape: [B,C_out] â†’ [B,C_out,1,1]<br>
                        ã€€ h = conv1 + time_proj â†’ [B,C_out,H,W]<br><br>

                        5. norm2 = GroupNorm(h) â†’ [B,C_out,H,W]<br>
                        ã€€ act2 = SiLU(norm2) â†’ [B,C_out,H,W]<br>
                        ã€€ conv2 = Conv2d(act2, Wâ‚‚, bâ‚‚) â†’ [B,C_out,H,W]<br><br>

                        6. skipå¤„ç†:<br>
                        ã€€ if C_in â‰  C_out:<br>
                        ã€€ã€€ skip = Conv1Ã—1(x): [B,C_in,H,W] â†’ [B,C_out,H,W]<br>
                        ã€€ else: skip = x<br><br>

                        7. output = conv2 + skip â†’ [B,C_out,H,W]
                    </div>
                </div>

                <div>
                    <h3>ğŸ¯ æ³¨æ„åŠ›æœºåˆ¶å¼ é‡æµåŠ¨</h3>
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; font-family: monospace; font-size: 10px; line-height: 1.5;">
                        <strong>è¾“å…¥:</strong> x [B, C, H, W] = [4, 128, 64, 64]<br>
                        <strong>å‚æ•°:</strong> heads=8, head_dim=C/heads=16<br><br>

                        <strong>è®¡ç®—æ­¥éª¤:</strong><br>
                        1. norm = GroupNorm(x) â†’ [4, 128, 64, 64]<br><br>

                        2. é‡å¡‘ä¸ºåºåˆ—:<br>
                        ã€€ flat = norm.view(4, 128, 4096)<br>
                        ã€€ seq = flat.transpose(1,2) â†’ [4, 4096, 128]<br><br>

                        3. QKVæŠ•å½±:<br>
                        ã€€ q = Linear_q(seq): [4,4096,128] Ã— W_q[128,128]<br>
                        ã€€ k = Linear_k(seq): [4,4096,128] Ã— W_k[128,128]<br>
                        ã€€ v = Linear_v(seq): [4,4096,128] Ã— W_v[128,128]<br>
                        ã€€ â†’ q,k,v: [4,4096,128]<br><br>

                        4. å¤šå¤´é‡å¡‘:<br>
                        ã€€ q = q.view(4,4096,8,16).transpose(1,2) â†’ [4,8,4096,16]<br>
                        ã€€ k,v åŒæ ·æ“ä½œ â†’ [4,8,4096,16]<br><br>

                        5. æ³¨æ„åŠ›è®¡ç®—:<br>
                        ã€€ scores = q @ k.transpose(-2,-1) / âˆš16<br>
                        ã€€ [4,8,4096,16] @ [4,8,16,4096] â†’ [4,8,4096,4096]<br>
                        ã€€ attn = softmax(scores, dim=-1)<br>
                        ã€€ out = attn @ v â†’ [4,8,4096,16]<br><br>

                        6. å¤šå¤´åˆå¹¶:<br>
                        ã€€ out = out.transpose(1,2).contiguous()<br>
                        ã€€ out = out.view(4,4096,128)<br>
                        ã€€ out = Linear_out(out) â†’ [4,4096,128]<br><br>

                        7. é‡å¡‘å¹¶æ®‹å·®:<br>
                        ã€€ out = out.transpose(1,2).view(4,128,64,64)<br>
                        ã€€ result = x + out â†’ [4,128,64,64]
                    </div>
                </div>
            </div>
        </div>

        <!-- Complete Forward Pass Example -->
        <div style="margin-top: 30px; background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; padding: 25px; border-radius: 15px;">
            <h2 style="margin-bottom: 20px;">ğŸ”„ å®Œæ•´å‰å‘ä¼ æ’­ç¤ºä¾‹</h2>

            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px;">
                <h3>è®­ç»ƒæ—¶çš„å®Œæ•´æ•°æ®æµ (Batch=4, Image=64Ã—64Ã—3):</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <h4 style="color: #ffeaa7;">ğŸš€ æ­¥éª¤ 1-3: æ•°æ®å‡†å¤‡</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; font-size: 10px;">
                            <strong>1. é‡‡æ ·è¾“å…¥:</strong><br>
                            xâ‚€ ~ DataLoader â†’ [4,3,64,64]<br>
                            t ~ Uniform(1,1000) â†’ [4,] (ä¾‹: [150,320,890,45])<br>
                            Îµ ~ ğ’©(0,I) â†’ [4,3,64,64]<br><br>

                            <strong>2. æŸ¥è¡¨Î±Ì…â‚œ:</strong><br>
                            Î±Ì…[150] = 0.8234 (é¢„è®¡ç®—å€¼)<br>
                            Î±Ì…[320] = 0.6891<br>
                            Î±Ì…[890] = 0.0567<br>
                            Î±Ì…[45] = 0.9456<br><br>

                            <strong>3. å‰å‘æ‰©æ•£:</strong><br>
                            âˆšÎ±Ì…â‚œ â†’ [4,1,1,1] (å¹¿æ’­)<br>
                            âˆš(1-Î±Ì…â‚œ) â†’ [4,1,1,1]<br>
                            xâ‚œ = âˆšÎ±Ì…â‚œâŠ™xâ‚€ + âˆš(1-Î±Ì…â‚œ)âŠ™Îµ<br>
                            â†’ xâ‚œ [4,3,64,64]
                        </div>
                    </div>

                    <div>
                        <h4 style="color: #fdcb6e;">ğŸ§  æ­¥éª¤ 4-6: ç½‘ç»œæ¨ç†</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; font-size: 10px;">
                            <strong>4. æ—¶é—´åµŒå…¥:</strong><br>
                            t [4,] â†’ sin/cosç¼–ç  â†’ [4,128]<br>
                            MLP: [4,128] â†’ [4,512] â†’ [4,512]<br><br>

                            <strong>5. U-Netå‰å‘:</strong><br>
                            è¾“å…¥: (xâ‚œ[4,3,64,64], t_emb[4,512])<br>
                            Input Conv: [4,3,64,64] â†’ [4,128,64,64]<br>
                            Encoder: 64â†’32â†’16â†’8 (ä¿å­˜skips)<br>
                            Bottleneck: [4,512,8,8] + Attention<br>
                            Decoder: 8â†’16â†’32â†’64 (ä½¿ç”¨skips)<br>
                            Output: [4,3,64,64]<br><br>

                            <strong>6. å™ªå£°é¢„æµ‹:</strong><br>
                            ÎµÌ‚â‚œ = ÎµÎ¸(xâ‚œ, t) â†’ [4,3,64,64]
                        </div>
                    </div>

                    <div>
                        <h4 style="color: #fab1a0;">ğŸ“Š æ­¥éª¤ 7-9: æŸå¤±è®¡ç®—</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; font-size: 10px;">
                            <strong>7. æŸå¤±è®¡ç®—:</strong><br>
                            diff = Îµ - ÎµÌ‚â‚œ â†’ [4,3,64,64]<br>
                            squared = diff ** 2 â†’ [4,3,64,64]<br>
                            loss = mean(squared) â†’ scalar<br><br>

                            <strong>8. åå‘ä¼ æ’­:</strong><br>
                            âˆ‡_Î¸ loss â†’ å„å±‚æ¢¯åº¦<br>
                            Convå±‚: âˆ‡W, âˆ‡b<br>
                            æ—¶é—´åµŒå…¥: âˆ‡W_time<br>
                            æ³¨æ„åŠ›: âˆ‡W_q, âˆ‡W_k, âˆ‡W_v<br><br>

                            <strong>9. å‚æ•°æ›´æ–°:</strong><br>
                            Adamä¼˜åŒ–å™¨:<br>
                            m_t = Î²â‚m_{t-1} + (1-Î²â‚)âˆ‡Î¸<br>
                            v_t = Î²â‚‚v_{t-1} + (1-Î²â‚‚)(âˆ‡Î¸)Â²<br>
                            Î¸ = Î¸ - Î·Â·mÌ‚_t/(âˆšvÌ‚_t + Îµ)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sampling Process -->
        <div style="margin-top: 30px; background: linear-gradient(135deg, #fd79a8, #fdcb6e); color: white; padding: 25px; border-radius: 15px;">
            <h2 style="margin-bottom: 20px;">ğŸ¨ æ¨ç†é‡‡æ ·è¿‡ç¨‹</h2>

            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px;">
                <h3>DDPMé‡‡æ ·ç®—æ³• (ç”Ÿæˆæ–°å›¾åƒ):</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div>
                        <h4 style="color: #2d3436;">åˆå§‹åŒ–é˜¶æ®µ:</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; font-size: 11px;">
                            <strong>1. çº¯å™ªå£°åˆå§‹åŒ–:</strong><br>
                            xâ‚œ ~ ğ’©(0,I) â†’ [B,3,64,64]<br>
                            ä¾‹: xâ‚â‚€â‚€â‚€ = torch.randn(4,3,64,64)<br><br>

                            <strong>2. é¢„åŠ è½½æ¨¡å‹:</strong><br>
                            ÎµÎ¸.eval() - è®¾ç½®è¯„ä¼°æ¨¡å¼<br>
                            Î±, Î±Ì…, Î² é¢„è®¡ç®—æŸ¥æ‰¾è¡¨<br>
                            Ïƒâ‚œ = âˆš(Î²â‚œ(1-Î±Ì…â‚œâ‚‹â‚)/(1-Î±Ì…â‚œ))
                        </div>
                    </div>

                    <div>
                        <h4 style="color: #2d3436;">è¿­ä»£å»å™ª:</h4>
                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; font-size: 11px;">
                            <strong>For t = T, T-1, ..., 1:</strong><br><br>

                            <strong>3. å™ªå£°é¢„æµ‹:</strong><br>
                            t_batch = [t,t,t,t] â†’ [4,]<br>
                            ÎµÌ‚ = ÎµÎ¸(xâ‚œ, t_batch) â†’ [4,3,64,64]<br><br>

                            <strong>4. å‡å€¼è®¡ç®—:</strong><br>
                            Î¼â‚œ = (xâ‚œ - Î²â‚œ/âˆš(1-Î±Ì…â‚œ)Â·ÎµÌ‚)/âˆšÎ±â‚œ<br>
                            â†’ [4,3,64,64]<br><br>

                            <strong>5. æ·»åŠ å™ªå£° (t>1):</strong><br>
                            z ~ ğ’©(0,I) â†’ [4,3,64,64]<br>
                            xâ‚œâ‚‹â‚ = Î¼â‚œ + Ïƒâ‚œÂ·z â†’ [4,3,64,64]<br><br>

                            <strong>6. æœ€ç»ˆè¾“å‡º (t=1):</strong><br>
                            xâ‚€ = Î¼â‚ â†’ [4,3,64,64] (ç”Ÿæˆå›¾åƒ)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Memory and Performance -->
        <div style="margin-top: 30px; background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; padding: 25px; border-radius: 15px;">
            <h2 style="margin-bottom: 20px;">ğŸ“Š æ€§èƒ½åˆ†æä¸ä¼˜åŒ–</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div>
                    <h3>ğŸ’¾ å†…å­˜ä½¿ç”¨åˆ†æ</h3>
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; font-size: 11px;">
                        <strong>å‰å‘ä¼ æ’­å†…å­˜:</strong><br>
                        â€¢ è¾“å…¥: 4Ã—3Ã—64Â²Ã—4B = 196KB<br>
                        â€¢ ç‰¹å¾å›¾64Ã—64: 4Ã—128Ã—64Â²Ã—4B = 8MB<br>
                        â€¢ ç‰¹å¾å›¾32Ã—32: 4Ã—256Ã—32Â²Ã—4B = 4MB<br>
                        â€¢ ç‰¹å¾å›¾16Ã—16: 4Ã—512Ã—16Â²Ã—4B = 2MB<br>
                        â€¢ ç‰¹å¾å›¾8Ã—8: 4Ã—512Ã—8Â²Ã—4B = 512KB<br>
                        â€¢ æ³¨æ„åŠ›64Ã—64: 4Ã—8Ã—4096Â²Ã—4B = 2GB<br>
                        â€¢ æ¢¯åº¦ (è®­ç»ƒ): ~2Ã—å‰å‘å†…å­˜<br><br>

                        <strong>å³°å€¼å†…å­˜:</strong> ~6GB (FP32)<br>
                        <strong>ä¼˜åŒ–å:</strong> ~3GB (FP16 + æ¢¯åº¦æ£€æŸ¥ç‚¹)
                    </div>
                </div>

                <div>
                    <h3>âš¡ è®¡ç®—å¤æ‚åº¦</h3>
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; font-size: 11px;">
                        <strong>FLOPsåˆ†æ (å•æ¬¡å‰å‘):</strong><br>
                        â€¢ Input Conv: 4Ã—3Ã—128Ã—64Â²Ã—9 = 94M<br>
                        â€¢ ResNet Blocks: ~500M<br>
                        â€¢ Self-Attention: 4Ã—8Ã—4096Â²Ã—16 = 8.6B<br>
                        â€¢ Skip Connections: ~50M<br>
                        â€¢ Total: ~9.2B FLOPs<br><br>

                        <strong>è®­ç»ƒæ—¶é—´ (V100):</strong><br>
                        â€¢ å•æ­¥: ~100ms<br>
                        â€¢ å®Œæ•´é‡‡æ ·: ~100s (1000æ­¥)<br>
                        â€¢ DDIMå¿«é€Ÿé‡‡æ ·: ~5s (50æ­¥)
                    </div>
                </div>

                <div>
                    <h3>ğŸ›ï¸ è¶…å‚æ•°è®¾ç½®</h3>
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; font-size: 11px;">
                        <strong>ç½‘ç»œå‚æ•°:</strong><br>
                        â€¢ Base channels: 128<br>
                        â€¢ Channel multipliers: [1,2,4,4]<br>
                        â€¢ Attention resolutions: [16,8]<br>
                        â€¢ ResNet blocks per level: 2<br>
                        â€¢ Dropout: 0.1<br><br>

                        <strong>è®­ç»ƒå‚æ•°:</strong><br>
                        â€¢ Learning rate: 2e-4<br>
                        â€¢ Batch size: 4 (ç¤ºä¾‹)<br>
                        â€¢ EMA decay: 0.9999<br>
                        â€¢ Total timesteps: T=1000<br>
                        â€¢ Noise schedule: linear
                    </div>
                </div>
            </div>
        </div>

        <!-- Mathematical Foundations -->
        <div style="margin-top: 30px; background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 25px; border-radius: 15px;">
            <h2 style="margin-bottom: 20px;">ğŸ“ æ•°å­¦åŸºç¡€ä¸æ ¸å¿ƒå…¬å¼</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                <div>
                    <h3>ğŸ”¢ æ ¸å¿ƒæ¦‚ç‡å…¬å¼</h3>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; font-family: monospace; font-size: 11px; line-height: 1.6;">
                        <strong>å‰å‘è¿‡ç¨‹ (åŠ å™ª):</strong><br>
                        q(xâ‚œ|xâ‚œâ‚‹â‚) = ğ’©(xâ‚œ; âˆš(1-Î²â‚œ)xâ‚œâ‚‹â‚, Î²â‚œI)<br>
                        q(xâ‚œ|xâ‚€) = ğ’©(xâ‚œ; âˆšÎ±Ì…â‚œxâ‚€, (1-Î±Ì…â‚œ)I)<br><br>

                        <strong>åå‘è¿‡ç¨‹ (å»å™ª):</strong><br>
                        pÎ¸(xâ‚œâ‚‹â‚|xâ‚œ) = ğ’©(xâ‚œâ‚‹â‚; Î¼Î¸(xâ‚œ,t), Ïƒâ‚œÂ²I)<br>
                        Î¼Î¸(xâ‚œ,t) = 1/âˆšÎ±â‚œ(xâ‚œ - Î²â‚œ/âˆš(1-Î±Ì…â‚œ)ÎµÎ¸(xâ‚œ,t))<br><br>

                        <strong>å˜åˆ†ä¸‹ç•Œ:</strong><br>
                        ğ”¼[-log pÎ¸(xâ‚€)] â‰¤ ğ”¼[Lâ‚œ] + ğ”¼[Lâ‚€] + ğ”¼[Lâ‚œ]<br>
                        å…¶ä¸­ Lâ‚œ = DKL(q(xâ‚œâ‚‹â‚|xâ‚œ,xâ‚€)||pÎ¸(xâ‚œâ‚‹â‚|xâ‚œ))
                    </div>
                </div>

                <div>
                    <h3>âš™ï¸ å®ç°ä¸­çš„å¼ é‡æ“ä½œ</h3>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; font-family: monospace; font-size: 11px; line-height: 1.6;">
                        <strong>é‡å‚æ•°åŒ–é‡‡æ ·:</strong><br>
                        # é¢„è®¡ç®—ç³»æ•°<br>
                        sqrt_alpha_bar = âˆšÎ±Ì…â‚œ  # [4,1,1,1]<br>
                        sqrt_one_minus_alpha_bar = âˆš(1-Î±Ì…â‚œ)  # [4,1,1,1]<br>

                        # å‰å‘æ‰©æ•£<br>
                        noise = torch.randn_like(x0)  # [4,3,64,64]<br>
                        x_t = sqrt_alpha_bar * x0 + sqrt_one_minus_alpha_bar * noise<br><br>

                        <strong>ç½‘ç»œé¢„æµ‹:</strong><br>
                        # æ—¶é—´åµŒå…¥<br>
                        t_emb = time_embedding(t)  # [4,512]<br>

                        # U-Netæ¨ç†<br>
                        eps_pred = unet(x_t, t_emb)  # [4,3,64,64]<br>

                        # æŸå¤±è®¡ç®—<br>
                        loss = F.mse_loss(noise, eps_pred)  # scalar
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive Controls -->
        <div style="margin-top: 30px; text-align: center; padding: 20px; background: linear-gradient(135deg, #74b9ff, #0984e3); border-radius: 15px;">
            <h3 style="margin-bottom: 20px; color: white;">ğŸ® äº¤äº’å¼æ¶æ„æµè§ˆ</h3>
            <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px;">
                <button class="interactive-btn btn-forward" onclick="highlightPath('forward')" id="btn-forward">
                    ğŸ“ˆ å‰å‘æ‰©æ•£è¿‡ç¨‹
                </button>
                <button class="interactive-btn btn-reverse" onclick="highlightPath('reverse')" id="btn-reverse">
                    ğŸ“‰ åå‘å»å™ªè¿‡ç¨‹
                </button>
                <button class="interactive-btn btn-unet" onclick="highlightPath('unet')" id="btn-unet">
                    ğŸ—ï¸ U-Netæ¶æ„
                </button>
                <button class="interactive-btn btn-reset" onclick="resetHighlight()" id="btn-reset">
                    ğŸ”„ é‡ç½®è§†å›¾
                </button>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <h3 style="margin-top: 0; color: #2c3e50; margin-bottom: 15px;">ğŸ“š å›¾ä¾‹è¯´æ˜</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div>
                    <h4 style="color: #e74c3c;">å¼ é‡ä¸æ“ä½œ</h4>
                    <div class="tensor-box" style="margin: 5px 0;">å¼ é‡å½¢çŠ¶ [B,C,H,W]</div>
                    <div class="operation-box" style="margin: 5px 0;">æ•°å­¦æ“ä½œ</div>
                    <div class="layer-box" style="margin: 5px 0; display: block;">ç½‘ç»œå±‚æ¨¡å—</div>
                </div>
                <div>
                    <h4 style="color: #3498db;">ç‰¹æ®Šæ¨¡å—</h4>
                    <div class="attention-box" style="margin: 5px 0; display: block;">è‡ªæ³¨æ„åŠ›æœºåˆ¶</div>
                    <div class="time-embed-box" style="margin: 5px 0; display: block;">æ—¶é—´ä¿¡æ¯åµŒå…¥</div>
                    <div style="margin: 8px 0; font-size: 12px;">
                        <span style="color: #f39c12;">âš¡</span> è·³è·ƒè¿æ¥è·¯å¾„
                    </div>
                </div>
                <div>
                    <h4 style="color: #27ae60;">ç¬¦å·è¯´æ˜</h4>
                    <div style="font-size: 11px; line-height: 1.6;">
                        <strong>B:</strong> Batch Size (æ‰¹é‡å¤§å°)<br>
                        <strong>C:</strong> Channels (é€šé“æ•°)<br>
                        <strong>H:</strong> Height (å›¾åƒé«˜åº¦)<br>
                        <strong>W:</strong> Width (å›¾åƒå®½åº¦)<br>
                        <strong>T:</strong> Total timesteps (æ€»æ—¶é—´æ­¥)<br>
                        <strong>âŠ›:</strong> å·ç§¯æ“ä½œ<br>
                        <strong>âŠ™:</strong> å…ƒç´ ä¹˜æ³•
                    </div>
                </div>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #bdc3c7; font-size: 11px; color: #7f8c8d;">
                ğŸ’¡ <strong>ä½¿ç”¨æç¤º:</strong> æ‚¬åœæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ | ç‚¹å‡»æŒ‰é’®é«˜äº®ä¸åŒéƒ¨åˆ† | æ»šåŠ¨U-NetåŒºåŸŸæŸ¥çœ‹å®Œæ•´æ¶æ„
            </div>
        </div>
    </div>

    <script>
        let currentHighlight = null;

        function highlightPath(type) {
            // Reset previous highlights
            resetHighlight();

            const sections = document.querySelectorAll('.process-section');
            const buttons = document.querySelectorAll('.interactive-btn');

            // Add click animation to button
            const clickedBtn = document.getElementById(`btn-${type}`);
            if (clickedBtn) {
                clickedBtn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    clickedBtn.style.transform = 'scale(1)';
                }, 150);
            }

            // Dim all sections first
            sections.forEach(section => {
                section.classList.add('dimmed');
            });

            // Highlight specific section
            let targetSection;
            switch(type) {
                case 'forward':
                    targetSection = document.getElementById('forward-section');
                    targetSection.style.borderColor = '#e74c3c';
                    targetSection.style.boxShadow = '0 0 30px rgba(231, 76, 60, 0.6)';
                    break;
                case 'reverse':
                    targetSection = document.getElementById('reverse-section');
                    targetSection.style.borderColor = '#27ae60';
                    targetSection.style.boxShadow = '0 0 30px rgba(39, 174, 96, 0.6)';
                    break;
                case 'unet':
                    targetSection = document.getElementById('unet-section');
                    targetSection.style.borderColor = '#3498db';
                    targetSection.style.boxShadow = '0 0 30px rgba(52, 152, 219, 0.6)';
                    break;
            }

            if (targetSection) {
                targetSection.classList.remove('dimmed');
                targetSection.classList.add('highlighted');
                currentHighlight = type;

                // Scroll into view smoothly
                targetSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }

        function resetHighlight() {
            const sections = document.querySelectorAll('.process-section');
            const buttons = document.querySelectorAll('.interactive-btn');

            // Add click animation to reset button
            const resetBtn = document.getElementById('btn-reset');
            if (resetBtn) {
                resetBtn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    resetBtn.style.transform = 'scale(1)';
                }, 150);
            }

            sections.forEach(section => {
                section.classList.remove('highlighted', 'dimmed');
                section.style.borderColor = '';
                section.style.boxShadow = '';
                section.style.transform = '';
                section.style.opacity = '';
            });

            currentHighlight = null;
        }

        // Add ripple effect to buttons
        function createRipple(event) {
            const button = event.currentTarget;
            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - button.offsetLeft - radius}px`;
            circle.style.top = `${event.clientY - button.offsetTop - radius}px`;
            circle.classList.add('ripple');

            const ripple = button.getElementsByClassName('ripple')[0];
            if (ripple) {
                ripple.remove();
            }

            button.appendChild(circle);
        }

        // Add event listeners for enhanced interactions
        document.addEventListener('DOMContentLoaded', function() {
            // Add ripple effect to all buttons
            const buttons = document.querySelectorAll('.interactive-btn');
            buttons.forEach(button => {
                button.addEventListener('click', createRipple);
            });

            // Add hover animations to tensor boxes
            const tensorBoxes = document.querySelectorAll('.tensor-box, .operation-box');
            tensorBoxes.forEach(box => {
                box.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05) translateY(-2px)';
                    this.style.boxShadow = '0 6px 12px rgba(0,0,0,0.3)';
                });

                box.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1) translateY(0)';
                    this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                });
            });

            // Add smooth scrolling for layer boxes
            const layerBoxes = document.querySelectorAll('.layer-box, .attention-box, .time-embed-box');
            layerBoxes.forEach(box => {
                box.addEventListener('click', function() {
                    this.style.transform = 'scale(1.02)';
                    this.style.transition = 'all 0.2s ease';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 200);
                });
            });
        });

        // Add CSS for ripple effect
        const style = document.createElement('style');
        style.textContent = `
            .ripple {
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.6);
                transform: scale(0);
                animation: ripple-animation 0.6s linear;
                pointer-events: none;
            }

            @keyframes ripple-animation {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }

            .interactive-btn {
                position: relative;
                overflow: hidden;
            }

            .pulse-animation {
                animation: pulse-glow 1.5s ease-in-out infinite;
            }

            @keyframes pulse-glow {
                0%, 100% {
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                }
                50% {
                    box-shadow: 0 8px 16px rgba(52, 152, 219, 0.4);
                }
            }

            .section-transition {
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
        `;
        document.head.appendChild(style);

        // Add section transition classes
        document.querySelectorAll('.process-section').forEach(section => {
            section.classList.add('section-transition');
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case '1':
                    highlightPath('forward');
                    break;
                case '2':
                    highlightPath('reverse');
                    break;
                case '3':
                    highlightPath('unet');
                    break;
                case 'Escape':
                case '0':
                    resetHighlight();
                    break;
            }
        });

        // Add auto-tour functionality
        function startAutoTour() {
            const sections = ['forward', 'reverse', 'unet'];
            let currentIndex = 0;

            function nextSection() {
                if (currentIndex < sections.length) {
                    highlightPath(sections[currentIndex]);
                    currentIndex++;
                    setTimeout(nextSection, 3000);
                } else {
                    resetHighlight();
                }
            }

            nextSection();
        }

        // Add tour button
        const controlsDiv = document.querySelector('.interactive-btn').parentElement;
        const tourBtn = document.createElement('button');
        tourBtn.className = 'interactive-btn';
        tourBtn.style.background = 'linear-gradient(135deg, #00b894, #00a085)';
        tourBtn.innerHTML = 'ğŸ¬ è‡ªåŠ¨æ¼”ç¤º';
        tourBtn.onclick = startAutoTour;
        controlsDiv.appendChild(tourBtn);

        // Add performance monitoring
        let performanceMetrics = {
            renderTime: 0,
            interactionCount: 0
        };

        function trackInteraction() {
            performanceMetrics.interactionCount++;
            console.log(`äº¤äº’æ¬¡æ•°: ${performanceMetrics.interactionCount}`);
        }

        // Track render time
        const startTime = performance.now();
        window.addEventListener('load', function() {
            performanceMetrics.renderTime = performance.now() - startTime;
            console.log(`é¡µé¢æ¸²æŸ“æ—¶é—´: ${performanceMetrics.renderTime.toFixed(2)}ms`);
        });

        // Add interaction tracking
        document.querySelectorAll('.interactive-btn').forEach(btn => {
            btn.addEventListener('click', trackInteraction);
        });

        // Add smooth entrance animation
        function animateEntrance() {
            const sections = document.querySelectorAll('.process-section');
            sections.forEach((section, index) => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(30px)';

                setTimeout(() => {
                    section.style.transition = 'all 0.6s ease';
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, index * 200);
            });
        }

        // Start entrance animation when page loads
        window.addEventListener('load', animateEntrance);

        // Add accessibility features
        document.addEventListener('keydown', function(event) {
            if (event.altKey) {
                switch(event.key) {
                    case 'f':
                        highlightPath('forward');
                        event.preventDefault();
                        break;
                    case 'r':
                        highlightPath('reverse');
                        event.preventDefault();
                        break;
                    case 'u':
                        highlightPath('unet');
                        event.preventDefault();
                        break;
                }
            }
        });

        // Add help tooltip
        function showHelp() {
            alert(`ğŸ¯ DDPMæ¶æ„å›¾ä½¿ç”¨æŒ‡å—:\n\n` +
                  `ğŸ–±ï¸ é¼ æ ‡æ“ä½œ:\n` +
                  `â€¢ æ‚¬åœåœ¨å¼ é‡æ¡†ä¸ŠæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯\n` +
                  `â€¢ ç‚¹å‡»æŒ‰é’®é«˜äº®ä¸åŒéƒ¨åˆ†\n` +
                  `â€¢ ç‚¹å‡»æ¨¡å—æŸ¥çœ‹åŠ¨ç”»æ•ˆæœ\n\n` +
                  `âŒ¨ï¸ é”®ç›˜å¿«æ·é”®:\n` +
                  `â€¢ æ•°å­—é”®1: å‰å‘è¿‡ç¨‹\n` +
                  `â€¢ æ•°å­—é”®2: åå‘è¿‡ç¨‹\n` +
                  `â€¢ æ•°å­—é”®3: U-Netæ¶æ„\n` +
                  `â€¢ ESCæˆ–0: é‡ç½®è§†å›¾\n\n` +
                  `ğŸ¬ å…¶ä»–åŠŸèƒ½:\n` +
                  `â€¢ è‡ªåŠ¨æ¼”ç¤º: 3ç§’é—´éš”è‡ªåŠ¨åˆ‡æ¢\n` +
                  `â€¢ æ— éšœç¢æ”¯æŒ: Alt+F/R/Uå¿«æ·é”®`);
        }

        // Add help button
        const helpBtn = document.createElement('button');
        helpBtn.className = 'interactive-btn';
        helpBtn.style.background = 'linear-gradient(135deg, #ffeaa7, #fab1a0)';
        helpBtn.style.color = '#2d3436';
        helpBtn.innerHTML = 'â“ ä½¿ç”¨å¸®åŠ©';
        helpBtn.onclick = showHelp;
        controlsDiv.appendChild(helpBtn);
    </script>
</body>
</html>